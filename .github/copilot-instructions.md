# Copilot Instructions

- Model policy: enable Claude Sonnet 4.5 for all clients when available.
- This is an Android LLM chat app. UI + business logic live in [app/src/main/java/com/example/aishiz/MainActivity.kt](app/src/main/java/com/example/aishiz/MainActivity.kt); llama.cpp JNI bridge is in [app/src/main/cpp/native-lib.cpp](app/src/main/cpp/native-lib.cpp) with build config in [app/src/main/cpp/CMakeLists.txt](app/src/main/cpp/CMakeLists.txt).
- UI flow: left drawer manages models, right drawer manages per-model inference params, center shows chat list via [app/src/main/java/com/example/aishiz/ChatAdapter.kt](app/src/main/java/com/example/aishiz/ChatAdapter.kt) and [app/src/main/java/com/example/aishiz/ChatMessage.kt](app/src/main/java/com/example/aishiz/ChatMessage.kt).
- Persistence: models + params stored in JSON strings inside SharedPreferences via [app/src/main/java/com/example/aishiz/AishizPrefs.kt](app/src/main/java/com/example/aishiz/AishizPrefs.kt). Adding a model auto-creates default params and selects it if none exists.
- Model storage: when starting native generation we copy the SAF-selected URI into internal storage (deduplicated by UUID) via [app/src/main/java/com/example/aishiz/ModelStorage.kt](app/src/main/java/com/example/aishiz/ModelStorage.kt). Extension guessing prefers .gguf/.bin.
- Inference params object is [app/src/main/java/com/example/aishiz/InferenceParams.kt](app/src/main/java/com/example/aishiz/InferenceParams.kt); UI read/write happens in MainActivity (save/reset buttons). Defaults: temp 0.70, topP 0.95, topK 40, repeatPenalty 1.10, maxTokens 256, ctx 2048, seed -1.
- Sending message: `onSend()` appends a user message, inserts an empty assistant message, then tries native streaming first (JNI). If native unavailable or fails, falls back to a Kotlin stub that types out an echo header.
- JNI bridge: [app/src/main/java/com/example/aishiz/NativeLlamaBridge.kt](app/src/main/java/com/example/aishiz/NativeLlamaBridge.kt) exports `startGeneration` (returns requestId) and `stopGeneration`; `System.loadLibrary("aishiz_native")` is executed in the object initializer.
- Native pipeline (native-lib.cpp): for each request we load the GGUF model (llama.cpp), init context, configure sampler (temp/topP/topK/repeatPenalty/seed), tokenize prompt, run a generation loop, and stream token strings to the Kotlin callback. EOS or stop flag ends generation; cleanup frees sampler/context/model and detaches thread.
- Cancellation: MainActivity tracks `generationJob` (stub) and `activeNativeRequestId` (native). `stopGeneration()` cancels both paths; always reset `activeNativeRequestId` on complete/error.
- Drawer actions: model select/remove buttons update prefs + adapter; params drawer uses number sliders/text inputs. Keep adapters in sync by calling `refreshModelsUi()`, `loadParamsIntoUi()`, and `updateActiveModelLabel()` after changes.
- Build: requires llama.cpp submodule; clone with `--recurse-submodules` or run `git submodule init && git submodule update`. Use `./gradlew assembleDebug` (or the `testClasses` alias) to build; `ndkVersion` pinned to 26.1.10909125 and buildToolsVersion 36.0.0 in [app/build.gradle.kts](app/build.gradle.kts).
- Native build: CMake enables llama.cpp common lib, disables CURL and OpenMP/Kleidi for mobile. ABI filters: arm64-v8a and x86_64. Context defaults in native code (n_ctx 2048, n_batch 512, n_threads 4); adjust there if threading/batching changes are needed.
- Streaming UI: `ChatAdapter.updateLastAssistantText()` replaces the last assistant entry; it finds the last `Role.ASSISTANT` item. Ensure order is preserved (user then placeholder assistant) to avoid index issues.
- Error handling: native path reports errors via callback `onError(message)` which updates the last assistant message in MainActivity. Kotlin stub does not currently surface errors; extend if you add non-JNI inference.
- Model picker: uses SAF OpenDocument with persisted read permission; some providers may reject persistable grants (caught and ignored).
- Testing: no bespoke test tasks; instrumented/unit tests are stock template. For quick sanity, launch emulator/device and run the app; stop button should cancel both stub and native runs.
- If adding features, follow the existing pattern of simple data classes + adapters and keep JNI signatures stable (update both Kotlin and C++ if you change params).
